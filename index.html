<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emitir Relat√≥rios SERPRO</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f6fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .titlebar {
      -webkit-app-region: drag;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      padding: 0 12px;
      font-weight: 600;
      font-size: 14px;
    }

    .titlebar img {
      height: 22px;
      margin-right: 8px;
      -webkit-app-region: no-drag;
    }

    .titlebar span {
      flex: 1;
    }

    .container {
      flex: 1;
      background: white;
      display: flex;
      gap: 0;
      overflow: hidden;
    }

    .form-section {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .logs-section {
      flex: 1;
      padding: 20px;
      background: #f8f9fa;
      border-left: 2px solid #e9ecef;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      margin-bottom: 15px;
    }

    .header h1 {
      color: #333;
      font-size: 20px;
      margin-bottom: 4px;
    }

    .header p {
      color: #666;
      font-size: 13px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #333;
      font-weight: 500;
      font-size: 13px;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-input-button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 15px;
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      color: #6c757d;
      font-size: 13px;
      transition: all 0.3s ease;
      cursor: pointer;
      width: 100%;
      margin-bottom: 5px;
    }

    .file-input-button:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }

    .file-input-button.has-file {
      background: #d4edda;
      border-color: #28a745;
      color: #155724;
    }

    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 13px;
      transition: border-color 0.3s ease;
    }

    input[type="text"]:focus, input[type="password"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .hint {
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }

    .submit-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin-top: 10px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
    }

    .submit-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
      color: #667eea;
    }

    .status {
      display: flex;
      flex-direction: column;
      gap: 15px;
      height: 100%;
    }

    .status h3 {
      margin-bottom: 10px;
      color: #333;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      background: #e9ecef;
      color: #666;
    }

    .status-content {
      flex: 1;
      overflow-y: auto;
      background: white;
      padding: 10px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      white-space: pre-wrap;
      border: 1px solid #dee2e6;
      max-height: 300px;
    }

    .success-log {
      color: #28a745;
    }

    .error-log {
      color: #dc3545;
    }

    .logoImg {
      height: 50px;
      width: 50px;
      align-self: center;
    }

    .debug-info {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 11px;
      font-family: monospace;
      max-width: 300px;
      display: none;
    }

    .connection-status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 8px;
    }

    .connection-status.connected {
      background: #28a745;
    }

    .connection-status.disconnected {
      background: #dc3545;
    }

    .close-btn {
      -webkit-app-region: no-drag;
      background: transparent;
      border: none;
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s ease;
      width: 40px;
      height: 40px;
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .notification-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .notification-modal.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .notification-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    .notification-content .icon {
      font-size: 60px;
      margin-bottom: 15px;
    }

    .notification-content h2 {
      color: #333;
      margin-bottom: 10px;
      font-size: 24px;
    }

    .notification-content p {
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
      white-space: pre-line;
    }

    .notification-content button {
      padding: 12px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .notification-content button:hover {
      transform: translateY(-2px);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .status-badge.pulsing {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>
  <div class="titlebar">
    <img src="RelaEcac_logo-removebg.png" alt="Logo">
    <span>RelaEcac <span class="connection-status" id="connectionStatus"></span></span>
    <button id="closeBtn" class="close-btn" title="Fechar">‚úñ</button>
  </div>

  <div class="container">
    <div class="form-section">
      <div class="header">
        <img class="logoImg" src="RelaEcac_logo-removebg.png" alt="logo">
        <h1>Rela-Ecac</h1>
        <p>Sistema de Emiss√£o Autom√°tica de Relat√≥rio Fiscal via SERPRO</p>
      </div>

      <form id="relatoriosForm" enctype="multipart/form-data">
        <div class="form-group">
          <label>üìú Certificado Digital (.pfx)</label>
          <div class="file-input-wrapper">
            <input type="file" id="certificado" name="certificado" accept=".pfx" class="file-input">
            <div class="file-input-button" id="certificadoButton">
              üìÅ Clique para selecionar novo certificado (opcional)
            </div>
          </div>
          <div class="hint">Deixe em branco para usar o certificado atual</div>
        </div>

        <div class="form-group">
          <label for="senha">üîí Senha do Certificado</label>
          <input type="password" id="senha" name="senha" placeholder="Digite a senha do certificado">
        </div>

        <div class="form-group">
          <label>üìÅ Pasta para Salvar PDFs</label>
          <div class="hint" style="margin-bottom: 10px; color: #dc3545; font-weight: 600;">
            ‚ö†Ô∏è Digite o caminho completo (ex: C:\Relatorios) ou deixe vazio para usar a pasta padr√£o
          </div>
          <input type="text" id="pdfDir" name="pdfDir" placeholder="Ex: C:\Relatorios (ou deixe vazio)">
          <div class="hint">
            ‚Ä¢ Caminho completo: <strong>C:\Relatorios</strong> ou <strong>C:\Users\SeuNome\Desktop\PDFs</strong><br>
            ‚Ä¢ Pasta relativa: <strong>relatorios_2024</strong> (cria dentro do AppData)<br>
            ‚Ä¢ Deixe vazio para usar a pasta padr√£o <strong>pdfs</strong>
          </div>
        </div>

        <div class="form-group">
          <label>üìä Arquivo Excel (.xlsx)</label>
          <div class="file-input-wrapper">
            <input type="file" id="excel" name="excel" accept=".xlsx,.xls" class="file-input" required>
            <div class="file-input-button" id="excelButton">
              üìÅ Clique para selecionar o arquivo Excel
            </div>
          </div>
          <div class="hint">Lista de empresas (CNPJs na coluna C)</div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          ‚ö° Processar Relat√≥rios
        </button>
      </form>

      <div class="loading" id="loading">
        <p>Processando relat√≥rios...</p>
      </div>
    </div>

    <div class="logs-section">
      <div class="status" id="status">
        <div>
          <h3>
            ‚úÖ Sucessos 
            <span class="status-badge" id="successBadge">Aguardando</span>
          </h3>
          <div class="status-content success-log" id="successLog">Aguardando processamento...</div>
        </div>
        <div>
          <h3>
            ‚ùå Erros
            <span class="status-badge" id="errorBadge">0 erros</span>
          </h3>
          <div class="status-content error-log" id="errorLog">Nenhum erro registrado...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="notification-modal" id="notificationModal">
    <div class="notification-content">
      <div class="icon">üéâ</div>
      <h2>Processamento Conclu√≠do!</h2>
      <p id="notificationMessage">Todos os relat√≥rios foram gerados com sucesso.</p>
      <button onclick="fecharNotificacao()">OK, Entendi!</button>
    </div>
  </div>

  <div class="debug-info" id="debugInfo">
    <div>Debug Mode</div>
    <div id="debugContent"></div>
  </div>

  <script>
    let monitoramentoAtivo = false;
    let intervaloMonitoramento = null;

    function mostrarNotificacao(tipo, mensagem) {
      const modal = document.getElementById('notificationModal');
      const icon = modal.querySelector('.icon');
      const title = modal.querySelector('h2');
      const message = document.getElementById('notificationMessage');

      if (tipo === 'success') {
        icon.textContent = 'üéâ';
        title.textContent = 'Processamento Conclu√≠do!';
      } else if (tipo === 'error') {
        icon.textContent = '‚ùå';
        title.textContent = 'Erro no Processamento';
      }

      message.textContent = mensagem;
      modal.classList.add('show');
    }

    function fecharNotificacao() {
      document.getElementById('notificationModal').classList.remove('show');
    }

    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        const debugInfo = document.getElementById('debugInfo');
        debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
      }
    });

    function addDebug(msg) {
      const debugContent = document.getElementById('debugContent');
      const timestamp = new Date().toLocaleTimeString();
      debugContent.innerHTML = `[${timestamp}] ${msg}<br>` + debugContent.innerHTML;
      console.log(`[DEBUG] ${msg}`);
    }

    async function testarConexao() {
      const statusIndicator = document.getElementById('connectionStatus');
      try {
        const response = await fetch('http://localhost:3000/config');
        if (response.ok) {
          statusIndicator.className = 'connection-status connected';
          addDebug('‚úÖ Conectado ao servidor');
          return true;
        }
      } catch (error) {
        statusIndicator.className = 'connection-status disconnected';
        addDebug('‚ùå Servidor desconectado: ' + error.message);
        return false;
      }
    }

    document.getElementById('certificado').addEventListener('change', function(e) {
      const button = document.getElementById('certificadoButton');
      if (e.target.files.length > 0) {
        button.textContent = `üìú ${e.target.files[0].name}`;
        button.classList.add('has-file');
        addDebug('Certificado selecionado: ' + e.target.files[0].name);
      } else {
        button.textContent = 'üìÅ Clique para selecionar novo certificado (opcional)';
        button.classList.remove('has-file');
      }
    });

    document.getElementById('excel').addEventListener('change', function(e) {
      const button = document.getElementById('excelButton');
      if (e.target.files.length > 0) {
        button.textContent = `üìä ${e.target.files[0].name}`;
        button.classList.add('has-file');
        addDebug('Excel selecionado: ' + e.target.files[0].name);
      } else {
        button.textContent = 'üìÅ Clique para selecionar o arquivo Excel';
        button.classList.remove('has-file');
      }
    });

    async function carregarConfiguracoes() {
      try {
        addDebug('Carregando configura√ß√µes...');
        const response = await fetch('http://localhost:3000/config');
        const config = await response.json();
        
        if (config.certPassword) {
          document.getElementById('senha').value = config.certPassword;
          addDebug('Senha carregada do config');
        }
        if (config.pdfDir) {
          document.getElementById('pdfDir').value = config.pdfDir;
          addDebug('PdfDir carregado: ' + config.pdfDir);
        }
      } catch (error) {
        console.error('Erro ao carregar configura√ß√µes:', error);
        addDebug('‚ùå Erro ao carregar config: ' + error.message);
      }
    }

    document.getElementById('relatoriosForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const pdfDirValue = document.getElementById('pdfDir').value.trim();

      console.log('üìÅ Valor do campo pdfDir:', pdfDirValue);
      addDebug('üìÅ Caminho digitado: ' + (pdfDirValue || 'vazio (usar√° padr√£o)'));

      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');

      submitBtn.disabled = true;
      loading.style.display = 'block';

      try {
        addDebug('Enviando requisi√ß√£o para /processar...');
        const response = await fetch('http://localhost:3000/processar', {
          method: 'POST',
          body: formData
        });

        addDebug('Resposta recebida: ' + response.status);
        const result = await response.json();

        if (result.success) {
          addDebug('‚úÖ Sucesso: ' + result.message);
          iniciarMonitoramento();
        } else {
          alert('‚ùå ' + result.message);
          addDebug('‚ùå Erro: ' + result.message);
        }
      } catch (error) {
        alert('‚ùå Erro: ' + error.message);
        addDebug('‚ùå Exce√ß√£o: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        loading.style.display = 'none';
      }
    });

    function iniciarMonitoramento() {
      if (monitoramentoAtivo) {
        addDebug('‚ö†Ô∏è Monitoramento j√° est√° ativo');
        return;
      }

      monitoramentoAtivo = true;
      addDebug('üîÑ Iniciando monitoramento de logs...');

      const successBadge = document.getElementById('successBadge');
      const errorBadge = document.getElementById('errorBadge');

      successBadge.textContent = 'Monitorando...';
      successBadge.style.background = '#ffc107';
      successBadge.classList.add('pulsing');

      intervaloMonitoramento = setInterval(async () => {
        try {
          const response = await fetch('http://localhost:3000/status');
          
          if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
          }

          const status = await response.json();
          
          addDebug(`üìä Status: ${status.success?.length || 0} chars success, ${status.errors?.length || 0} chars errors`);

          const successLog = document.getElementById('successLog');
          const errorLog = document.getElementById('errorLog');

          if (status.success) {
            successLog.textContent = status.success;
            successLog.scrollTop = successLog.scrollHeight;
          }

          if (status.errors) {
            errorLog.textContent = status.errors;
            errorLog.scrollTop = errorLog.scrollHeight;
            
            const errorCount = (status.errors.match(/‚ùå/g) || []).length;
            errorBadge.textContent = errorCount > 0 ? `${errorCount} erro(s)` : '0 erros';
            errorBadge.style.background = errorCount > 0 ? '#dc3545' : '#28a745';
            errorBadge.style.color = 'white';
          }

          if (status.success && status.success.includes('‚úÖ Processamento conclu√≠do com sucesso!')) {
            addDebug('üéâ Processamento conclu√≠do');
            pararMonitoramento();
            
            successBadge.textContent = 'Conclu√≠do';
            successBadge.style.background = '#28a745';
            successBadge.style.color = 'white';
            successBadge.classList.remove('pulsing');

            const pdfPath = status.success.match(/üìÅ PDFs salvos em: (.+)/);
            const totalProcessados = status.success.match(/üìä Total de protocolos processados: (\d+)/);
            
            let mensagem = 'Todos os relat√≥rios foram gerados com sucesso.';
            if (pdfPath && pdfPath[1]) {
              mensagem += `\n\nPDFs salvos em:\n${pdfPath[1]}`;
            }
            if (totalProcessados && totalProcessados[1]) {
              mensagem += `\n\nTotal processado: ${totalProcessados[1]} empresa(s)`;
            }
            
            mostrarNotificacao('success', mensagem);
          }
        } catch (error) {
          console.error('Erro ao buscar status:', error);
          addDebug('‚ùå Erro ao buscar status: ' + error.message);
          
          const conectado = await testarConexao();
          if (!conectado) {
            pararMonitoramento();
            mostrarNotificacao('error', 'Conex√£o perdida com o servidor. Verifique se o servidor est√° rodando.');
          }
        }
      }, 2000);

      setTimeout(() => {
        if (monitoramentoAtivo) {
          addDebug('‚è±Ô∏è Timeout de monitoramento (5 min)');
          pararMonitoramento();
        }
      }, 300000);
    }

    function pararMonitoramento() {
      if (intervaloMonitoramento) {
        clearInterval(intervaloMonitoramento);
        intervaloMonitoramento = null;
      }
      monitoramentoAtivo = false;
      addDebug('‚èπÔ∏è Monitoramento parado');
    }

    document.addEventListener('DOMContentLoaded', async function() {
      addDebug('üöÄ Aplica√ß√£o iniciada');
      await testarConexao();
      await carregarConfiguracoes();
      setInterval(testarConexao, 10000);
    });

    window.addEventListener('beforeunload', () => {
      pararMonitoramento();
    });

    document.getElementById('closeBtn').addEventListener('click', () => {
      if (window.electronAPI && window.electronAPI.closeApp) {
        window.electronAPI.closeApp();
      } else {
        window.close();
      }
    });
  </script>
</body>
</html>